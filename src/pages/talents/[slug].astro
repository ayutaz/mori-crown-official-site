---
import { getCollection, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const talents = await getCollection('talents');
  return talents.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry }
  }));
}

const { entry } = Astro.props as { entry: CollectionEntry<'talents'> };
const { Content } = await render(entry);
const toHref = (path: string) => `${import.meta.env.BASE_URL}${path.replace(/^\/+/, '')}`;
const withBase = (path: string) => `${import.meta.env.BASE_URL}${path.replace(/^\/+/, '')}`;

const relatedNews = [...(await getCollection('news'))]
  .filter((item) => item.data.relatedTalents.includes(entry.slug))
  .sort((a, b) => b.data.date.localeCompare(a.data.date))
  .slice(0, 3);
---

<BaseLayout title={`${entry.data.name} | MORI CROWN!`} description={entry.data.summary}>
  <div class="container">
    <section class="page-hero surface">
      <p class="eyebrow">{entry.data.generation} / {entry.data.role}</p>
      <h1>{entry.data.name}</h1>
      <p>{entry.data.catchphrase}</p>
    </section>

    <section class="section detail-grid">
      <div class="detail-image surface" style="padding: 0.9rem;">
        <img src={withBase(entry.data.image)} alt={`${entry.data.name} 立ち絵`} />
      </div>

      <div class="grid" style="gap: 0.9rem;">
        <article class="panel">
          <h2 style={`color:${entry.data.color};`}>プロフィール</h2>
          <dl class="info-list">
            <div><dt>かな</dt><dd>{entry.data.nameKana}</dd></div>
            <div><dt>英語名</dt><dd>{entry.data.nameEn}</dd></div>
            <div><dt>誕生日</dt><dd>{entry.data.birthday}</dd></div>
            <div><dt>身長</dt><dd>{entry.data.height}</dd></div>
            <div><dt>ファン名</dt><dd>{entry.data.fanName}</dd></div>
            <div><dt>ファンマーク</dt><dd>{entry.data.fanMark}</dd></div>
          </dl>

          <h3 style="margin-bottom: 0.3rem;">配信カテゴリ</h3>
          <div class="pill-row">
            {entry.data.streamFocus.map((tag) => <span class="pill">{tag}</span>)}
          </div>
        </article>

        <article class="panel post-content">
          <Content />
        </article>

        <article class="panel">
          <h3>ハッシュタグ</h3>
          <div class="pill-row">
            <span class="pill">{entry.data.hashtags.overall}</span>
            <span class="pill">{entry.data.hashtags.stream}</span>
            <span class="pill">{entry.data.hashtags.fanart}</span>
            <span class="pill">{entry.data.hashtags.clip}</span>
          </div>
          <div class="cta-row" style="margin-top: 0.8rem;">
            <a class="button button-ghost" href={toHref('/fan-works/')}>ファン活動ガイド</a>
            <a class="button button-primary" href={toHref('/schedule/')}>配信を見る</a>
          </div>
        </article>
      </div>
    </section>

    <section class="section">
      <div class="section-title-row">
        <h2>関連ニュース</h2>
        <a class="text-link" href={toHref('/news/')}>一覧へ</a>
      </div>
      <div class="grid grid-3">
        {relatedNews.map((item) => (
          <article class="card">
            <p class="small-muted">{item.data.date} / {item.data.category}</p>
            <h3><a href={toHref(`/news/${item.slug}/`)}>{item.data.title}</a></h3>
            <p>{item.data.excerpt}</p>
          </article>
        ))}
      </div>
      <a class="back-link" href={toHref('/talents/')}>タレント一覧へ戻る</a>
    </section>
  </div>
</BaseLayout>
