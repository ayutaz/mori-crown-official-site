---
import { getCollection, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const news = await getCollection('news');
  return news.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry }
  }));
}

const { entry } = Astro.props as { entry: CollectionEntry<'news'> };
const { Content } = await render(entry);
const toHref = (path: string) => `${import.meta.env.BASE_URL}${path.replace(/^\/+/, '')}`;

const allNews = [...(await getCollection('news'))]
  .filter((item) => item.slug !== entry.slug)
  .sort((a, b) => b.data.date.localeCompare(a.data.date))
  .slice(0, 3);
---

<BaseLayout title={`${entry.data.title} | MORI CROWN!`} description={entry.data.excerpt}>
  <div class="container">
    <section class="page-hero surface">
      <p class="eyebrow">{entry.data.category}</p>
      <h1>{entry.data.title}</h1>
      <p>{entry.data.date}</p>
    </section>

    <div class="section detail-grid">
      <article class="panel post-content">
        <Content />

        {entry.data.ctaHref && entry.data.ctaLabel && (
          <a class="button button-primary" style="margin-top: 0.9rem;" href={toHref(entry.data.ctaHref)}>
            {entry.data.ctaLabel}
          </a>
        )}

        <a class="back-link" href={toHref('/news/')}>ニュース一覧へ戻る</a>
      </article>

      <aside class="panel">
        <h2>関連ニュース</h2>
        <div class="grid" style="gap: 0.7rem;">
          {allNews.map((item) => (
            <article class="notice">
              <p class="small-muted" style="margin: 0;">{item.data.date}</p>
              <h3 style="margin: 0.2rem 0 0.35rem; font-size: 1rem;">
                <a href={toHref(`/news/${item.slug}/`)}>{item.data.title}</a>
              </h3>
              <a class="text-link" style="margin: 0;" href={toHref(`/news/${item.slug}/`)}>読む</a>
            </article>
          ))}
        </div>
      </aside>
    </div>
  </div>
</BaseLayout>
